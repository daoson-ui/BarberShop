<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Th√™m L·ªãch h·∫πn</title>

    <style>
        body {
            font-family: Arial;
            background: #f5f5f5;
            padding: 30px;
        }

        .container {
            width: 450px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ccc;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .dv-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            max-height: 180px;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 15px;
            cursor: pointer;
        }

        .button {
            display: block;
            text-align: center;
            padding: 10px;
            margin-top: 15px;
            border-radius: 6px;
            background: #555;
            color: white;
            text-decoration: none;
        }

        .alert-error {
            color: red;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        /* gi·ªù b·∫≠n */
        .busy {
            background: #ffcccc;
            color: #555;
            font-weight: bold;
        }

        /* gi·ªù r·∫£nh */
        .free {
            background: #ccffcc;
            font-weight: bold;
        }

    </style>
</head>
<body>

<div class="container">
    <h2>Th√™m L·ªãch h·∫πn</h2>

    <div th:if="${errorMsg}" class="alert-error" th:text="${errorMsg}"></div>

    <form th:action="@{/user/lichhen/save}" method="post" id="addForm">

        <!-- Ng√†y h·∫πn -->
        <label>Ng√†y h·∫πn</label>
        <input type="date" name="ngayHen" id="ngayHen" required/>

        <!-- Nh√¢n vi√™n -->
        <label>Nh√¢n vi√™n:</label>
        <select name="manv" id="manv" required>
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
            <option th:each="nv : ${listNhanVien}"
                    th:value="${nv.manv}"
                    th:text="${nv.hoTen}">
            </option>
        </select>

        <!-- D·ªãch v·ª• -->
        <label>D·ªãch v·ª•:</label>
        <div class="dv-box">
            <label th:each="dv : ${listDichVu}" style="display:block; margin-bottom:5px;">
                <input type="checkbox" name="dichVuChon" id="dvIds"
                       th:value="${dv.maDv}"/>
                <span th:text="${dv.tenDv}"></span>
            </label>
        </div>

        <!-- Gi·ªù h·∫πn -->
        <label>Gi·ªù h·∫πn</label>
        <select name="gioHen" id="gioHen" required>
            <option value="">-- Ch·ªçn gi·ªù --</option>
        </select>

        <button type="submit">üíæ ƒê·∫∑t l·ªãch h·∫πn</button>
    </form>

    <a href="/user/home" class="button">‚Üê Quay l·∫°i</a>
</div>

<script>

/* =========================================================
   H√ÄM T·∫¢I DANH S√ÅCH GI·ªú R·∫¢NH T·ª™ BACKEND
========================================================= */
async function loadTimeSlots() {

    const ngay = document.getElementById('ngayHen').value;
    const manv = document.getElementById('manv').value;

    if (!ngay || !manv) return;

    let dvIds = [];
    document.querySelectorAll("input[name='dichVuChon']:checked").forEach(cb => {
        dvIds.push(cb.value);
    });

    // build URL
    let url = `/user/lichhen/api/timeslots?manv=${manv}&ngay=${ngay}`;

    dvIds.forEach(id => {
        url += `&dvIds[]=${id}`;
    });

    const response = await fetch(url);
    const data = await response.json();

    const select = document.getElementById('gioHen');
    select.innerHTML = '';

    data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.time;

        if (item.busy) {
            opt.textContent = `${item.time} (B·∫≠n)`;
            opt.classList.add("busy");
            opt.disabled = true;
        } else {
            opt.textContent = `${item.time}`;
            opt.classList.add("free");
        }

        select.appendChild(opt);
    });
}

/* =========================================================
   S·ª∞ KI·ªÜN T·ª∞ ƒê·ªòNG LOAD GI·ªú R·∫¢NH
========================================================= */
document.getElementById('ngayHen').addEventListener('change', loadTimeSlots);
document.getElementById('manv').addEventListener('change', loadTimeSlots);

// Khi ch·ªçn d·ªãch v·ª•
document.querySelectorAll("input[name='dichVuChon']").forEach(cb => {
    cb.addEventListener("change", loadTimeSlots);
});

/* =========================================================
   CH·∫∂N ƒê·∫∂T L·ªäCH QU√Å KH·ª®
========================================================= */
document.getElementById('addForm').addEventListener('submit', function (e) {

    const date = document.getElementById('ngayHen').value;
    const time = document.getElementById('gioHen').value;

    if (!date || !time) return;

    const selected = new Date(date + "T" + time);
    const now = new Date();

    if (selected < now) {
        e.preventDefault();
        alert("‚ùå Kh√¥ng th·ªÉ ƒë·∫∑t l·ªãch trong qu√° kh·ª©!");
    }
});

</script>

</body>
</html>
