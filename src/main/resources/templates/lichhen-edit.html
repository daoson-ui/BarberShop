<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>C·∫≠p nh·∫≠t L·ªãch h·∫πn</title>

    <style>
        body {
            font-family: Arial;
            background: #f4f4f4;
            padding: 20px;
        }

        .container {
            width: 480px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ccc;
        }

        h2 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 20px;
        }

        label {
            margin-top: 12px;
            display: block;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #aaa;
            border-radius: 5px;
        }

        .dv-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 12px;
        }

        .alert-error {
            background: #ffe0e0;
            border: 1px solid #d40000;
            color: #b30000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .busy {
            background: #ffcccc;
            font-weight: bold;
        }

        .free {
            background: #ccffcc;
            font-weight: bold;
        }

        button {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            background: #1976d2;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        a.button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 14px;
            background: #1976d2;
            color: white;
            border-radius: 5px;
            text-decoration: none;
        }
    </style>
</head>

<body>

<div class="container"
     th:data-current-time="${lichHen.gioHen}"
     th:data-id="${lichHen.maLh}">

    <h2>C·∫≠p nh·∫≠t L·ªãch h·∫πn</h2>

    <div th:if="${errorMsg}" class="alert-error" th:text="${errorMsg}"></div>

    <form th:action="@{/user/lichhen/edit}" method="post" id="editForm">

        <!-- ‚≠ê MUST HAVE: id="maLh" ƒë·ªÉ JS bi·∫øt excludeId -->
        <input type="hidden" name="maLh" id="maLh" th:value="${lichHen.maLh}"/>

        <!-- D·ªãch v·ª• -->
        <label>D·ªãch v·ª•:</label>
        <div class="dv-box">
            <label th:each="dv : ${listDichVu}">
                <input type="checkbox"
                       class="dv-check"
                       name="dichVuChon"
                       th:value="${dv.maDv}"
                       th:checked="${selectedDvIds.contains(dv.maDv)}" />
                <span th:text="${dv.tenDv}"></span>
            </label>
        </div>

        <!-- Nh√¢n vi√™n -->
        <label>Nh√¢n vi√™n:</label>
        <select id="nhanVien" name="nhanVien" required>
            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
            <option th:each="nv : ${listNhanVien}"
                    th:value="${nv.manv}"
                    th:text="${nv.hoTen}"
                    th:selected="${nv.manv == lichHen.nhanVien.manv}">
            </option>
        </select>

        <!-- Ng√†y -->
        <label>Ng√†y h·∫πn:</label>
        <input type="date" id="ngayHen" name="ngayHen"
               th:value="${lichHen.ngayHen}" required />

        <!-- Gi·ªù -->
        <label>Gi·ªù h·∫πn:</label>
        <select id="gioHen" name="gioHen" required>
            <option value="">-- Ch·ªçn gi·ªù --</option>
        </select>

        <button type="submit">üíæ C·∫≠p nh·∫≠t l·ªãch h·∫πn</button>
    </form>

    <a href="/user/home" class="button">‚Üê Quay l·∫°i</a>
</div>

<script>
(() => {
    const DEBOUNCE_MS = 300;
    const MIN_SLOT = "-- Ch·ªçn gi·ªù --";

    const ngayEl = document.getElementById('ngayHen');
    const manvEl = document.getElementById('nhanVien');
    const gioEl = document.getElementById('gioHen');
    const formEl = document.getElementById('editForm');
    const maLhEl = document.getElementById('maLh');
    const dvName = "dichVuChon";

    const cache = new Map();
    let currentAbort = null;

    function debounce(fn, ms) {
        let t = null;
        return (...args) => {
            if (t) clearTimeout(t);
            t = setTimeout(() => fn(...args), ms);
        };
    }

    function dvIdsKey(arr) {
        if (!arr || arr.length === 0) return "";
        return arr.map(x => String(x)).sort().join(',');
    }

    function readSelectedDvIds() {
        return Array.from(document.querySelectorAll(`input[name='${dvName}']:checked`))
            .map(n => n.value);
    }

    function showLoading() {
        gioEl.innerHTML = "";
        const o = document.createElement('option');
        o.textContent = "ƒêang t·∫£i...";
        o.disabled = true;
        gioEl.appendChild(o);
    }

    function resetSelect() {
        gioEl.innerHTML = "";
        const o = document.createElement('option');
        o.textContent = MIN_SLOT;
        gioEl.appendChild(o);
    }

    function setError(msg) {
        resetSelect();
        const o = document.createElement('option');
        o.textContent = "L·ªói: " + msg;
        o.disabled = true;
        gioEl.appendChild(o);
    }

    function renderSlots(data) {
        gioEl.innerHTML = "";
        const def = document.createElement('option');
        def.value = "";
        def.textContent = MIN_SLOT;
        gioEl.appendChild(def);

        data.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.time;

            opt.textContent = item.busy ? `${item.time} (B·∫≠n)` : item.time;
            if (item.busy) {
                opt.disabled = true;
                opt.classList.add("busy");
            } else {
                opt.classList.add("free");
            }

            gioEl.appendChild(opt);
        });

        // ‚≠ê Auto select gi·ªù c≈© n·∫øu r·∫£nh
        const oldTime = document.querySelector(".container").dataset.currentTime;
        if (oldTime) {
            const option = Array.from(gioEl.options).find(o => o.value === oldTime);
            if (option && !option.disabled) {
                option.selected = true;
            }
        }
    }

    async function _loadTimeSlots() {
        const ngay = ngayEl.value;
        const manv = manvEl.value;

        if (!ngay || !manv) {
            resetSelect();
            return;
        }

        const dvIds = readSelectedDvIds();
        const dvKey = dvIdsKey(dvIds);
        const excludeId = maLhEl.value;

        const cacheKey = `${manv}|${ngay}|${dvKey}|${excludeId}`;

        if (cache.has(cacheKey)) {
            renderSlots(cache.get(cacheKey));
            return;
        }

        if (currentAbort) {
            try { currentAbort.abort(); } catch (e) {}
        }

        currentAbort = new AbortController();
        const signal = currentAbort.signal;

        showLoading();

        const params = new URLSearchParams();
        params.set('manv', manv);
        params.set('ngay', ngay);
        params.set('excludeId', excludeId);
        dvIds.forEach(id => params.append('dvIds[]', id));

        const url = `/user/lichhen/api/timeslots?${params.toString()}`;

        try {
            const res = await fetch(url, { signal, cache: 'no-store' });
            if (!res.ok) {
                setError(`Server l·ªói ${res.status}`);
                return;
            }

            const data = await res.json();
            if (!Array.isArray(data)) {
                setError("D·ªØ li·ªáu sai ƒë·ªãnh d·∫°ng");
                return;
            }

            cache.set(cacheKey, data);
            renderSlots(data);

        } catch (err) {
            if (err.name === "AbortError") return;
            setError("M·∫•t k·∫øt n·ªëi, th·ª≠ l·∫°i");
        } finally {
            currentAbort = null;
        }
    }

    const loadTimeSlots = debounce(_loadTimeSlots, DEBOUNCE_MS);

    function wire() {
        ngayEl.addEventListener('change', loadTimeSlots);
        manvEl.addEventListener('change', loadTimeSlots);

        document.querySelectorAll(`input[name='${dvName}']`)
            .forEach(cb => cb.addEventListener('change', loadTimeSlots));

        formEl.addEventListener('submit', (e) => {
            const date = ngayEl.value;
            const time = gioEl.value;
            if (!date || !time) return;
            const sel = new Date(date + "T" + time);
            const now = new Date();
            if (sel < now) {
                e.preventDefault();
                alert("‚ùå Th·ªùi ƒëi·ªÉm ƒë√£ qua.");
            }
        });
    }

    wire();
    setTimeout(() => _loadTimeSlots(), 100);

})();
</script>

</body>
</html>
